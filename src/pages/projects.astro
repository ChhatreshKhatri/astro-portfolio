---
import RootLayout from "../layouts/RootLayout.astro";
import { Image } from "astro:assets";
import LinkButton from "../components/LinkButton.astro";
import Loading from "../components/Loading.astro";

interface Link {
  type: string;
  url: string;
  icon: string;
}
interface Project {
  heading: string;
  subHeading: string;
  description: string;
  image: string;
  links: Link[];
  tags: { name: string; url: string }[];
}
interface Projects {
  content: { title: string; description: string };
  projects: Project[];
}

let data: Projects | null = null;
try {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 5000); // 5s timeout
  
  const response = await fetch(import.meta.env.PUBLIC_API_URL + "/projects", {
    signal: controller.signal,
    headers: {
      'Cache-Control': 'public, max-age=3600',
    },
  });
  
  clearTimeout(timeoutId);
  data = await response.json();
} catch (error) {
  console.error("Error fetching data:", error);
  // Provide fallback
  data = {
    content: { title: "Projects", description: "My portfolio projects" },
    projects: [],
  };
}
---

<RootLayout title="Chhatresh Khatri | Projects" description="Chhatresh Khatri Projects. Explore a collection of diverse projects,  discover their unique features and access relevant links for more information." keywords="" page="projects">
  <div class="flex items-center justify-center rounded p-0.5 bg-linear-to-r from-ck1 to-ck2 opacity-0 animate-fade-in-down">
    <h1 class="flex justify-center items-center font-semibold tracking-wider text-xl xxs:text-2xl md:text-3xl p-1 px-2 bg-buttonBg dark:bg-darked rounded">My Projects</h1>
  </div>
  {
    data ? (
      data.projects.map((project, index) => (
        <section 
          class="group relative p-3 xs:p-6 xs:px-10 project-card opacity-0" 
          aria-labelledby={`project-${index}`}
          data-index={index}
        >
          <div class="absolute inset-0 rounded-lg bg-linear-to-r from-blue2/50 to-green2/50 opacity-20 transition-opacity duration-500 group-hover:opacity-50 animate-gradient" aria-hidden="true" />
          <div class="relative grid grid-cols-1 w-full lg:grid-cols-2 rounded-xl gap-1 xs:gap-4 lg:gap-8">
            <article class={`${(index + 1) % 2 ? "" : "lg:order-2"} project-content`}>
              <div class="w-full h-full flex flex-col justify-center items-center gap-2 md:gap-4">
                <h2 class="text-2xl xxs:text-3xl md:text-4xl xl:text-5xl font-semibold text-center project-heading opacity-0">{project.heading}</h2>
                <h3 class="text-xl md:text-2xl xxl:text-3xl text-center project-subheading opacity-0">{project.subHeading}</h3>
                <p class="text-md xs:text-xl text-justify project-description opacity-0">{project.description} </p>
                <nav class="flex flex-wrap items-center justify-center gap-2 xxs:gap-4 text-md xs:text-xl project-links opacity-0" aria-label={`${project.heading} links`}>
                  {project.links.map((link, linkIndex) => (
                    <LinkButton name={link.type} link={link.url} imageUrl={link.icon} pos={linkIndex % 2} loading={index === 0 ? "eager" : "lazy"} />
                  ))}
                </nav>
                <div class="flex flex-wrap items-center justify-center gap-2 xxs:gap-4 text-md xs:text-xl project-tags" role="list" aria-label={`${project.heading} technologies`}>
                  {project.tags?.map((tag, tagIndex) => (
                    <div 
                      title={tag.name} 
                      class="flex justify-center items-center font-semibold tracking-wider text-xl xxs:text-2xl md:text-3xl py-1 px-2 bg-buttonBg dark:bg-darked rounded border-2 border-dark dark:border-light transition-all duration-300 hover:scale-110 hover:rotate-3 project-tag cursor-pointer" 
                      role="listitem"
                      data-tag-index={tagIndex}
                      aria-label={tag.name}
                    >
                      <Image title={tag.name} src={tag.url} alt="" class="w-6 h-6 xs:w-8 xs:h-8 text-white" loading={index === 0 ? "eager" : "lazy"} inferSize aria-hidden="true" />
                    </div>
                  ))}
                </div>
              </div>
            </article>
            <aside class={`flex justify-start items-center mt-6 lg:mt-0 project-image ${(index + 1) % 2 ? "" : "lg:order-1"}`}>
              <figure class="w-full h-full flex justify-center items-center relative">
                <div aria-label={`Screenshot of ${project.heading} project`} class="w-full h-[300px] md:h-[350px] relative overflow-hidden rounded-2xl shadow-lg transition-all duration-300 hover:-translate-y-2 hover:shadow-2xl cursor-pointer">
                  <Image 
                    title={project.heading} 
                    src={project.image} 
                    alt={project.heading} 
                    class="w-full h-full object-cover object-top transition-all duration-4000 ease-in-out rounded-2xl hover:object-bottom" 
                    loading={index <= 1 ? "eager" : "lazy"}
                    width={1200}
                    height={800}
                  />
                </div>
              </figure>
            </aside>
          </div>
        </section>
      ))
    ) : (
      <Loading label="Loading projects" />
    )
  }
</RootLayout>

<script>
  // Intersection Observer for project cards with alternating animations
  document.addEventListener("DOMContentLoaded", () => {
    const observerOptions = {
      threshold: 0.15,
      rootMargin: "0px 0px -80px 0px"
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const card = entry.target as HTMLElement;
          const index = parseInt(card.dataset.index || "0");
          
          // Alternate slide direction
          card.classList.add((index + 1) % 2 === 0 ? 'animate-fade-in-right' : 'animate-fade-in-left');
          
          // Animate content elements with stagger
          const elements = [
            { selector: '.project-heading', delay: 0 },
            { selector: '.project-subheading', delay: 100 },
            { selector: '.project-description', delay: 200 },
            { selector: '.project-links', delay: 300 }
          ];
          
          setTimeout(() => {
            elements.forEach(({ selector, delay }) => {
              const element = card.querySelector(selector);
              if (element) {
                setTimeout(() => {
                  (element as HTMLElement).style.animation = 'fade-in-up 0.6s ease-out forwards';
                }, delay);
              }
            });
          }, 200);
          
          // Animate project tags with stagger
          const tags = card.querySelectorAll('.project-tag');
          tags.forEach((tag, tagIndex) => {
            setTimeout(() => {
              (tag as HTMLElement).style.animation = 'scale-in 0.5s ease-out forwards';
            }, 500 + tagIndex * 80);
          });
          
          observer.unobserve(entry.target);
        }
      });
    }, observerOptions);

    // Observe all project cards
    const projectCards = document.querySelectorAll('.project-card');
    projectCards.forEach(card => {
      // Hide tags initially
      const tags = card.querySelectorAll('.project-tag');
      tags.forEach(tag => {
        (tag as HTMLElement).style.opacity = '0';
      });
      observer.observe(card);
    });

    // Add parallax effect to project images on scroll
    let ticking = false;
    
    window.addEventListener('scroll', () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          const projectImages = document.querySelectorAll('.project-image');
          projectImages.forEach((imageContainer) => {
            const rect = imageContainer.getBoundingClientRect();
            const windowHeight = window.innerHeight;
            
            if (rect.top < windowHeight && rect.bottom > 0) {
              const scrollPercentage = (windowHeight - rect.top) / (windowHeight + rect.height);
              const translateY = (scrollPercentage - 0.5) * 30; // Parallax effect
              (imageContainer as HTMLElement).style.transform = `translateY(${translateY}px)`;
            }
          });
          ticking = false;
        });
        ticking = true;
      }
    });
  });
</script>
